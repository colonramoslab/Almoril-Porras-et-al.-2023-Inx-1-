%% Set up cryophilic point labeling
% An example script with annotations
%%

existsAndDefault('fromScratch', false);
%% LOADING FILES FROM DISK
% loading specific files by name
ts1 = tic;
existsAndDefault('marcmac', false);
if (marcmac)
    basedir =  '~/Documents/lab data/n2cryo/';
else
    basedir = '\\labnas2\WormData\David\Extracted\Spatial\N2\18-23GradientC25\Output Files';
end
d = dir(fullfile(basedir, '*.bin'));
nfiles = 24;
if (fromScratch)
    nfiles = min(nfiles, length(d));
    for j = 1:nfiles
        fnames{j} = fullfile(basedir, d(j).name); %#ok<SAGROW>
    end
    %fnames = {[basedir '20090226_N2g15_1823_tracks.bin'], [basedir '20090226_w1a_N2g15_1823_tracks.bin']};

    % load any track longer than 50 points
    minpts = 50;

    % this code snippet loads the files if we haven't already loaded them, but
    % otherwise skips them; that way we can change the script and rerun it
    % without having to reload the files
    if (~exist('tspat', 'var'))
        tspat = ExperimentSet.fromFiles(fnames{:}, 'minpts', minpts);
    end

    %% STITCH TRACKS
    % sometimes we miss a frame, so let's stitch together tracks that are close
    % by

    frameDiff = 3; % stitch together tracks if first ended 3 or fewer frames before second started
    maxDist = 7; % stitch together tracks if first ended within 7 pixels of second's start

    % For the script, I am executing this function with interactive off, but if
    % you set interactive to true, it will show you each potential stitch and
    % let you decide whether or not to stitch it
    tspat.executeExperimentFunction('stitchTracks', frameDiff, maxDist, 'interactive', false);

    %% CLEAN UP TRACKS
    % get rid of any tracks that don't go anywhere

    % create an EsetCleaner object

    ecl = ESetCleaner();

    % now let's look at the autogenerated report
    % let's get rid of all tracks less than 750 points and speed less than 0.4
    % pixels per second
    ecl.minPts = 750;
    ecl.minSpeed = 0.9;

    %ecl.getReport(tspat);

    % the following code just forces the figures to appear in the example documentation
    %{
    for j = 1:3
        figure(j);
        snapnow; 
    end
    %}

    % we've already shown the report, so we don't need to have it ask us first,
    % for the purposes of this script;  generally a good idea to leave this
    % enabled
    ecl.askFirst = false; 

    ecl.clean(tspat);
    disp('done with loading, stitching and cleaning');
    toc(ts1)
    ts1 = tic;
   % addTemperatureToExperiment(tspat.expt,'tmpchannel',8);
   leftedge = 0;
   rightedge = 2500;
   lefttemp = 18;
   righttemp = 23;
   tempfunc = @(xin, xdata, ydata) (righttemp-lefttemp)*(xin(1,:)-leftedge)/(rightedge-leftedge) + lefttemp;
   gq = GlobalQuantity;
   gq.derivationMethod = tempfunc;
   gq.xField = 'sloc';
   gq.fieldname = 'temp';
   tspat.executeExperimentFunction('addGlobalQuantity', gq);
   
   dtempfunc = @(xin, xdata, ydata) (righttemp-lefttemp)*(xin(1,:)-leftedge)/(rightedge-leftedge);
   gq.derivationMethod = dtempfunc;
   gq.xField = 'vel';
   gq.fieldname = 'dtemp';
   tspat.executeExperimentFunction('addGlobalQuantity', gq);
   
   
    
   % save (fullfile(basedir, 'marcmatfile.mat'), 'tspat');
    mkdir (fullfile(basedir, 'matfiles'));
    tspat.toMatFiles(fullfile(basedir, 'matfiles','thermo_temporal'));
    disp('saved file');
    toc(ts1)
    fromScratch = false;
    resegment = true;
else
    if (~exist('tspat', 'var'))
        ts1 = tic;
        tspat = ExperimentSet.fromMatFiles(fullfile(basedir, 'matfiles','thermo_temporal'));
        disp ('loaded eset from mat file');
        toc(ts1)
    end
end



existsAndDefault('resegment', false);
if (resegment)
    disp ('segmenting tracks');
    wso = WormSegmentOptions;
    ts1 = tic;
    tspat.executeExperimentFunction('segmentTracks', wso);
    disp ('done segmenting');
    toc(ts1)
    resegment = false;
    tspat.toMatFiles(fullfile(basedir, 'matfiles','thermo_temporal'));
    disp('saved file');
    toc(ts1);
end

fignum = 0;
fignum = fignum + 1; figure(fignum); clf(fignum);
dtx =  -5E-3:5E-5:5E-3;
tempreorate = tspat.makeReorientationHistogram('dtemp',dtx, 'makePlot', true);

fignum = fignum + 1; figure(fignum); clf(fignum);
dtx =  -1.5E-3:5E-5:1.5E-3;
tempreorated = tspat.makeReorientationHistogram('dtemp',dtx, 'makePlot', true, 'vsDistance', true);


fignum = fignum + 1; figure(fignum); clf(fignum);
xdat = tspat.gatherField('dtemp', 'runs');
ydat = abs(tspat.gatherField('deltatheta', 'runs'));
dtmax = 0.3;
%sum(ydat > dtmax)/length(ydat)
ydat(ydat > dtmax) = dtmax;
[dtc, mdt] = meanyvsx(xdat, ydat, dtx);
plot (dtc, mdt); title ('mean abs delta theta vs. temperature change');